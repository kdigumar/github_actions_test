# .github/workflows/deploy.yml
name: Deploy Workflow

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      ENV: ${{ inputs.environment }}

    steps:
      - name: ğŸ§¾ Checkout Code
        uses: actions/checkout@v3

      - name: â˜• Set Up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ—ï¸ Build with Maven
        run: |
          echo "ğŸ”§ Building JAR for environment: $ENV"
          mvn clean package
          echo "âœ… Maven build complete. JAR is in ./target"

      - name: ğŸ“¡ Get Host List
        id: get-hosts
        run: |
          echo "ğŸŒ Retrieving VM host list for environment: $ENV"
          if [[ "$ENV" == "systest" ]]; then
            echo "hosts=${{ secrets.SYSTEST_VM_HOSTS }}" >> $GITHUB_OUTPUT
            echo "âœ… Hosts loaded for systest"
          else
            echo "âŒ Environment '$ENV' not recognized!"
            exit 1
          fi

      - name: ğŸš€ Deploy JAR to VMs
        env:
          HOSTS: ${{ steps.get-hosts.outputs.hosts }}
          USERNAME: ${{ secrets.SYSTEST_VM_USERNAME }}
          PASSWORD: ${{ secrets.SYSTEST_VM_PASSWORD }}
        run: |
          echo "===== Deployment Configuration ====="
          echo "ğŸ”„ Environment   : $ENV"
          echo "ğŸ‘¤ Username      : $USERNAME"
          echo "ğŸ” Password      : $PASSWORD"   # âš ï¸ Remove after testing
          echo "ğŸŒ VM Hosts      : $HOSTS"
          echo "====================================="

          echo "ğŸ“¦ Starting deployment to VMs..."
          IFS=',' read -ra ADDR <<< "$HOSTS"

          for host in "${ADDR[@]}"; do
            echo "â¡ï¸  Attempting connection to $host"

            # Optional: check connectivity
            ping -c 2 "$host" > /dev/null 2>&1
            if [[ $? -ne 0 ]]; then
              echo "âŒ Cannot reach $host â€” skipping"
              continue
            fi
            echo "âœ… $host is reachable"

            echo "â¡ï¸  Connecting to $host with user: $USERNAME"
            sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no "$USERNAME@$host" "echo 'ğŸ” Connected to $host as $USERNAME'" || {
              echo "âŒ SSH connection to $host failed"
              continue
            }

            echo "ğŸš€ Uploading JAR to $host:/desired/remote/path/"
            sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no ./target/*.jar "$USERNAME@$host:/home/user/app
              continue
            }

            echo "âœ… Deployment completed on $host"
          done

      - name: âœ… Deployment Done
        run: |
          echo "ğŸ‰ All reachable hosts processed for environment: $ENV"
