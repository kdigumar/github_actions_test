# .github/workflows/deploy.yml
name: Deploy Workflow

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      ENV: ${{ inputs.environment }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build with Maven
        run: mvn clean package

      - name: Get Host List
        id: get-hosts
        run: |
          if [[ "${{ env.ENV }}" == "systest" ]]; then
            echo "hosts=${{ secrets.SYSTEST_VM_HOSTS }}" >> $GITHUB_OUTPUT
          fi

      - name: Upload JAR to VMs
        env:
          HOSTS: ${{ steps.get-hosts.outputs.hosts }}
          USERNAME: ${{ secrets.SYSTEST_VM_USERNAME }}
          PASSWORD: ${{ secrets.SYSTEST_VM_PASSWORD }}
        run: |
          IFS=',' read -ra ADDR <<< "$HOSTS"
          for host in "${ADDR[@]}"; do
            echo "Connecting to server: $host"
            sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no ./target/*.jar "$USERNAME@$host:/home/user/app"
          done
